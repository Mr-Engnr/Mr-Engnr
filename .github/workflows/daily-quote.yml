name: Daily Quote Update
on:
  schedule:
    - cron: '15 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4

      - name: Fetch a random quote
        id: quote
        run: |
          RESPONSE=$(curl -sk --max-time 10 https://zenquotes.io/api/random)
          QUOTE=$(echo "$RESPONSE" | jq -r '.[0].q')
          AUTHOR=$(echo "$RESPONSE" | jq -r '.[0].a')
          TODAY=$(date -u '+%Y-%m-%d')

          if [ -z "$QUOTE" ] || [ "$QUOTE" = "null" ]; then
            echo "Failed to fetch quote"
            exit 1
          fi

          echo "quote_text=$QUOTE" >> $GITHUB_OUTPUT
          echo "quote_author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "update_date=$TODAY" >> $GITHUB_OUTPUT

      - name: Update README.md with the quote
        env:
          QUOTE: ${{ steps.quote.outputs.quote_text }}
          AUTHOR: ${{ steps.quote.outputs.quote_author }}
          DATE: ${{ steps.quote.outputs.update_date }}
        run: |
          python3 - <<'PYEOF'
          import re, os
          quote  = os.environ['QUOTE']
          author = os.environ['AUTHOR']
          date   = os.environ['DATE']
          block  = f"\n## Quote of the Day ðŸš€\n\n> {quote}  \n> â€” {author}\n*(Updated: {date})*\n"
          with open("README.md", "r") as f:
              content = f.read()
          if "## Quote of the Day" in content:
              content = re.sub(r"\n## Quote of the Day[^\n]*\n.*?(?=\n## |\Z)", block, content, flags=re.DOTALL)
          else:
              content += block
          with open("README.md", "w") as f:
              f.write(content)
          PYEOF

      - name: Commit the change
        run: |
          git config user.name  "Mr-Engnr"
          git config user.email "ranasaad727@gmail.com"
          git add README.md
          git commit -m "chore: daily quote of the day $(date -u '+%Y-%m-%d')" || echo "No changes"
          git push
